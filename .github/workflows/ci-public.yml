# (c) Copyright 2025-2026 Hewlett Packard Enterprise Development LP
name: CI on PR

on:
  push:
    branches: [main, master, main-dev]
  pull_request_target:
    types: [opened, synchronize, reopened, labeled]
    branches: [main, master, main-dev]

permissions:
  contents: read
  checks: write
  issues: write

env:
  PYTHON_VERSIONS: "3.10,3.11,3.12"
  DEFAULT_PYTHON_VERSION: "3.11"
  UV_VERSION: "0.4.10"
  WORKING_DIR: src
  UV_CACHE_DIR: /tmp/.uv-cache

jobs:
  check-authorization:
    runs-on: ubuntu-latest
    outputs:
      authorized: ${{ steps.auth.outputs.authorized }}
    steps:
      - name: Authorization logic
        id: auth
        env:
          AUTH_TOKEN: ${{ secrets.AUTH_TOKEN || '' }}
          ORG: ${{ github.repository_owner }}
          TRUSTED_USERS: "lchinglen,vandewillysilva,chamur,alexandrealvino,sunkarar"
          TRUSTED_TEAMS: "gl-mcp"
        run: |
          # Push events are always authorized
          if [ "${{ github.event_name }}" = "push" ]; then
            echo "authorized=true" >> $GITHUB_OUTPUT
            echo "‚úÖ Push event - authorized"
            exit 0
          fi

          AUTHOR="${{ github.actor }}"
          HAS_LABEL=${{ contains(github.event.pull_request.labels.*.name, 'safe-to-test') }}

          if [ "$HAS_LABEL" = "true" ]; then
            echo "authorized=true" >> $GITHUB_OUTPUT
            echo "‚úÖ PR has 'safe-to-test' label - authorized"
            exit 0
          fi

          AUTHORIZED=false

          # Check trusted users FIRST - exit immediately if found
          if [ -n "$TRUSTED_USERS" ]; then
            IFS=',' read -r -a users <<< "$TRUSTED_USERS"
            for u in "${users[@]}"; do
              u_trimmed=$(echo "$u" | xargs)
              if [ "$u_trimmed" = "$AUTHOR" ]; then
                echo "‚úÖ User $AUTHOR is in TRUSTED_USERS list"
                echo "authorized=true" >> $GITHUB_OUTPUT
                echo "‚úÖ Authorized to run CI"
                exit 0
              fi
            done
            echo "User $AUTHOR not found in TRUSTED_USERS, checking API..."
          fi

          # Check org membership
          if [ -n "$AUTH_TOKEN" ] && [ "$AUTHORIZED" = "false" ]; then
            echo "Checking org membership for $AUTHOR..."
            membership=$(curl -s -o /dev/null -w "%{http_code}" \
              -H "Authorization: Bearer $AUTH_TOKEN" \
              -H "Accept: application/vnd.github+json" \
              "https://api.github.com/orgs/$ORG/members/$AUTHOR" || echo "000")
            
            if [ "$membership" = "204" ]; then
              AUTHORIZED=true
              echo "‚úÖ User $AUTHOR is a member of org $ORG"
            fi
          fi

          # Check team membership
          if [ -n "$AUTH_TOKEN" ] && [ -n "$TRUSTED_TEAMS" ] && [ "$AUTHORIZED" = "false" ]; then
            echo "Checking team membership for org: $ORG..."
            IFS=',' read -r -a teams <<< "$TRUSTED_TEAMS"
            
            for team in "${teams[@]}"; do
              team_trimmed=$(echo "$team" | xargs)
              if [ -z "$team_trimmed" ]; then continue; fi
              
              echo "Checking membership in team: $team_trimmed"
              
              # Try the team membership API
              team_membership=$(curl -s -w "%{http_code}" -o /tmp/team_response.json \
                -H "Authorization: Bearer $AUTH_TOKEN" \
                -H "Accept: application/vnd.github+json" \
                "https://api.github.com/orgs/$ORG/teams/$team_trimmed/memberships/$AUTHOR" || echo "000")
              
              if [ "$team_membership" = "200" ]; then
                # Check if the user is actually active in the team
                if grep -q '"state": "active"' /tmp/team_response.json 2>/dev/null; then
                  AUTHORIZED=true
                  echo "‚úÖ User $AUTHOR is an active member of team $team_trimmed"
                  break
                else
                  echo "‚ö†Ô∏è User $AUTHOR found in team $team_trimmed but not active"
                fi
              elif [ "$team_membership" = "403" ]; then
                # Check if it's a SAML SSO issue
                if grep -q "SAML enforcement" /tmp/team_response.json 2>/dev/null; then
                  echo "‚ö†Ô∏è SAML SSO enforcement detected - token needs organization authorization"
                  echo "üí° Please authorize your token for the glcp organization in GitHub settings"
                else
                  echo "‚ùå User $AUTHOR not authorized for team $team_trimmed (403 Forbidden)"
                fi
              else
                echo "‚ùå User $AUTHOR not found in team $team_trimmed (status: $team_membership)"
              fi
            done
          fi

          # Final decision
          if [ "$AUTHORIZED" = "true" ]; then
            echo "authorized=true" >> $GITHUB_OUTPUT
            echo "‚úÖ Authorized to run CI"
          else
            echo "authorized=false" >> $GITHUB_OUTPUT
            echo "‚ö†Ô∏è Not authorized - requires 'safe-to-test' label"
            echo "::warning::External PR requires 'safe-to-test' label"
          fi

  check-changes:
    name: Determine changeset
    runs-on: ubuntu-latest
    needs: [check-authorization]
    if: |
      (github.event_name == 'push') ||
      (github.event_name == 'pull_request_target' && needs.check-authorization.outputs.authorized == 'true')
    outputs:
      should-run: ${{ steps.determine-strategy.outputs.should_run }}
      servers: ${{ steps.determine-strategy.outputs.servers }}
    steps:
      - name: Check out repository
        uses: actions/checkout@v4.2.2
        with:
          ref: ${{ github.event_name == 'pull_request_target' && github.event.pull_request.head.sha || github.sha }}
          fetch-depth: 0

      - name: Check for changes in CI workflow
        id: check-workflow
        uses: tj-actions/changed-files@v46.0.0
        with:
          files: |
            .github/workflows/ci-public.yml
            
      - name: Check for changes in src directory
        id: check-src
        uses: tj-actions/changed-files@v46.0.0
        with:
          files: |
            src/**

      - name: Determine test strategy based on file changes
        id: determine-strategy
        run: |
          workflow_changed="${{ steps.check-workflow.outputs.any_changed }}"
          src_changed="${{ steps.check-src.outputs.any_changed }}"

          echo "Workflow changed: $workflow_changed"
          echo "Src changed: $src_changed"

          # Initialize final server list
          declare -a final_servers=()

          # If workflow changed - test all servers for safety
          if [[ "$workflow_changed" == "true" ]]; then
            echo "‚úÖ Workflow file changed - testing all servers"
            all_servers=$(find src/ -mindepth 1 -maxdepth 1 -type d -exec basename {} \; | grep -v "^\." | sort)
            final_servers=($all_servers)
            echo "Added all servers due to workflow changes: ${final_servers[@]}"
          fi

          # If src files changed - add changed servers
          if [[ "$src_changed" == "true" ]]; then
            changed_files="${{ steps.check-src.outputs.all_changed_files }}"
            echo "Changed src files: $changed_files"
            
            # Extract unique server directories from changed files
            changed_servers_json=$(echo "$changed_files" | tr ' ' '\n' | grep '^src/' | cut -d'/' -f2 | sort | uniq | jq -R -s -c 'split("\n")[:-1]')
            changed_servers_array=($(echo "$changed_servers_json" | jq -r '.[]'))
            echo "Changed servers from src: ${changed_servers_array[@]}"
            
            # Add changed servers to final list, avoiding duplicates
            for server in "${changed_servers_array[@]}"; do
              if [[ ! " ${final_servers[@]} " =~ " ${server} " ]]; then
                final_servers+=("$server")
                echo "Added $server from src changes"
              else
                echo "Skipped $server (already in list)"
              fi
            done
          fi

          # Convert final_servers array to JSON format
          if [[ ${#final_servers[@]} -gt 0 ]]; then
            # Use printf and jq for safer JSON generation
            servers_json=$(printf '%s\n' "${final_servers[@]}" | jq -R . | jq -s -c .)
            echo "üêõ DEBUG: servers_json = $servers_json"
            echo "üêõ DEBUG: Array length = ${#final_servers[@]}"
            echo "üêõ DEBUG: Array contents = ${final_servers[@]}"
            echo "should_run=true" >> "$GITHUB_OUTPUT"
            echo "servers=$servers_json" >> "$GITHUB_OUTPUT"
            echo "Final server list: $servers_json"
          else
            echo "should_run=false" >> "$GITHUB_OUTPUT"
            echo "servers=[]" >> "$GITHUB_OUTPUT"
            echo "No tests needed (no relevant changes)"
          fi

  lint-markdown:
    runs-on: ubuntu-latest
    name: Lint Markdown
    needs: [check-authorization, check-changes]
    if: |
      needs.check-changes.outputs.should-run == 'true' &&
      ((github.event_name == 'push') ||
       (github.event_name == 'pull_request_target' && needs.check-authorization.outputs.authorized == 'true'))
    steps:
      - name: Checkout code
        uses: actions/checkout@v4.2.2
        with:
          ref: ${{ github.event_name == 'pull_request_target' && github.event.pull_request.head.sha || github.sha }}

      - name: Setup Node.js
        uses: actions/setup-node@v4.1.0
        with:
          node-version: "20"

      - name: Install markdownlint-cli
        run: npm install -g markdownlint-cli@0.33.0

      - name: Lint markdown files
        run: markdownlint "**/*.md" --config .markdownlint.json

  ci-checks:
    name: MCP Server CI (${{ matrix.servers }}, Python ${{ matrix.python-version }})
    runs-on: ubuntu-latest
    environment: Pavo
    needs: [check-authorization, check-changes]
    if: |
      needs.check-changes.outputs.should-run == 'true' &&
      ((github.event_name == 'push') ||
       (github.event_name == 'pull_request_target' && needs.check-authorization.outputs.authorized == 'true'))
    strategy:
      matrix:
        servers: ${{ fromJson(needs.check-changes.outputs.servers) }}
        python-version: ["3.10", "3.11", "3.12"]
      fail-fast: false
    defaults:
      run:
        working-directory: ${{ github.workspace }}/${{ env.WORKING_DIR }}/${{ matrix.servers }}

    steps:

      - name: üêõ Debug Matrix Values
        run: |
          echo "=== Matrix Debug ==="
          echo "Server: '${{ matrix.servers }}'"
          echo "Python Version: '${{ matrix.python-version }}'"
          echo "Servers JSON from needs: '${{ needs.check-changes.outputs.servers }}'"
          echo "Should Run: '${{ needs.check-changes.outputs.should-run }}'"
          echo "==================="

      - name: üß™ CI for ${{ matrix.servers }}
        working-directory: . 
        run: |
            echo "::group::Starting CI for ${{ matrix.servers }} on Python ${{ matrix.python-version }}"
            echo "üîß Server: ${{ matrix.servers }}"
            echo "üêç Python: ${{ matrix.python-version }}"
            echo "üì¶ UV: ${{ env.UV_VERSION }}"
            echo "üìÅ Working Dir: ${{ env.WORKING_DIR }}/${{ matrix.servers }}"
            echo "::endgroup::"
            
            # Set job summary title
            echo "## üß™ CI Results for \`${{ matrix.servers }}\` (Python ${{ matrix.python-version }})" >> $GITHUB_STEP_SUMMARY

      - name: Checkout code
        uses: actions/checkout@v4.2.2
        with:
          ref: ${{ github.event_name == 'pull_request_target' && github.event.pull_request.head.sha || github.sha }}

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5.3.0
        with:
          python-version: ${{ matrix.python-version }}

      - name: Cache uv (Python ${{ matrix.python-version }})
        uses: actions/cache@v4.2.0
        with:
          path: ${{ env.UV_CACHE_DIR }}
          key: uv-${{ runner.os }}-${{ env.UV_VERSION }}-py${{ matrix.python-version }}-${{ hashFiles('**/pyproject.toml') }}
          restore-keys: |
            uv-${{ runner.os }}-${{ env.UV_VERSION }}-py${{ matrix.python-version }}-
            uv-${{ runner.os }}-${{ env.UV_VERSION }}-

      - name: Install uv
        run: |
          curl -LsSf https://astral.sh/uv/install.sh | sh
          echo "$HOME/.cargo/bin" >> $GITHUB_PATH
          echo "UV_CACHE_DIR=${{ env.UV_CACHE_DIR }}" >> $GITHUB_ENV

      - name: Install dependencies (Python ${{ matrix.python-version }})
        run: |
          uv sync --dev --python ${{ matrix.python-version }}

      - name: Install development tools
        run: |
          uv add ruff --dev
          uv add mypy --dev
          uv add bandit --dev
          uv add pip-audit --dev
          uv add pytest --dev
          uv add pytest-asyncio --dev

      
      # ==========================================
      # SECURITY & LICENSE COMPLIANCE CHECKS
      # (Only run once per server - on default Python version)
      # ==========================================
      
      - name: Secrets detection (detect-secrets)
        if: always() && matrix.python-version == env.DEFAULT_PYTHON_VERSION
        run: |
            echo "::group::Secret Detection (Python ${{ matrix.python-version }})"
            pip install detect-secrets
            if python3 ${{ github.workspace }}/scripts/check_secrets.py; then
            echo "‚úÖ No secrets detected"
            else
            echo "‚ùå Secrets detection failed"
            exit 1
            fi
            echo "::endgroup::"
        continue-on-error: false

      - name: Dependency vulnerability check (Pip Audit)
        if: always() && matrix.python-version == env.DEFAULT_PYTHON_VERSION
        run: |
          echo "::group::Dependency Vulnerability Check (Python ${{ matrix.python-version }})"
          python3 ${{ github.workspace }}/scripts/check_pip_audit.py
          echo "::endgroup::"
        continue-on-error: false

      - name: Upload pip-audit results
        uses: actions/upload-artifact@v4.4.3
        if: always() && matrix.python-version == env.DEFAULT_PYTHON_VERSION
        with:
          name: pip-audit-results-${{ matrix.servers }}
          path: ${{ env.WORKING_DIR }}/${{ matrix.servers }}/pip-audit-results.json

      - name: Check dependency licenses
        if: always() && matrix.python-version == env.DEFAULT_PYTHON_VERSION
        run: |
          echo "::group::License Compliance Check (Python ${{ matrix.python-version }})"
          uv add pip-licenses --dev
          uv run pip-licenses --format=json --output-file=licenses.json
          
          echo "üìã Dependency licenses:"
          uv run pip-licenses --format=markdown
          echo ""
          
          uv run python -c "
          import json
          import sys
          
          ALLOWED_LICENSES = [
              'MIT', 'MIT License',
              'Apache', 'Apache-2.0', 'Apache Software License',
              'BSD', 'BSD-3-Clause', 'BSD-2-Clause',
              'ISC', 'PSF', 'Unlicense', '0BSD',
          ]
          
          BLOCKED_LICENSES = [
              'GPL', 'GPLv2', 'GPLv3', 'GPL-2.0', 'GPL-3.0',
              'AGPL', 'AGPLv3', 'AGPL-3.0',
          ]
          
          with open('licenses.json') as f:
              packages = json.load(f)
          
          violations = []
          for pkg in packages:
              license_name = pkg.get('License', 'UNKNOWN')
              package_name = pkg.get('Name', 'unknown')
              version = pkg.get('Version', 'unknown')
              license_norm = license_name.upper()
              
              is_allowed = any(allowed.upper() in license_norm for allowed in ALLOWED_LICENSES)
              if is_allowed:
                  continue
              
              is_blocked = any(blocked.upper() in license_norm for blocked in BLOCKED_LICENSES)
              if is_blocked:
                  violations.append(f'{package_name} ({version}): {license_name}')
          
          if violations:
              print('‚ùå Incompatible licenses found:')
              for v in violations:
                  print(f'  - {v}')
              sys.exit(1)
          
          print('‚úÖ All licenses compatible with MIT')
          "
          echo "::endgroup::"
        continue-on-error: false

      - name: Upload license report
        uses: actions/upload-artifact@v4.4.3
        if: always() && matrix.python-version == env.DEFAULT_PYTHON_VERSION
        with:
          name: license-report-${{ matrix.servers }}
          path: ${{ env.WORKING_DIR }}/${{ matrix.servers }}/licenses.json

      - name: Run security analysis (Bandit)
        if: always() && matrix.python-version == env.DEFAULT_PYTHON_VERSION
        run: |
          echo "::group::Bandit Security Analysis (Python ${{ matrix.python-version }})"
          python3 ${{ github.workspace }}/scripts/check_bandit.py
          echo "::endgroup::"
        continue-on-error: false

      - name: Upload Bandit results
        uses: actions/upload-artifact@v4.4.3
        if: always() && matrix.python-version == env.DEFAULT_PYTHON_VERSION
        with:
          name: bandit-results-${{ matrix.servers }}
          path: ${{ env.WORKING_DIR }}/${{ matrix.servers }}/bandit-results.json

      # ==========================================
      # CODE QUALITY CHECKS (Run on all Python versions)
      # ==========================================

      - name: Run linter and formatter (Ruff) - Python ${{ matrix.python-version }}
        run: |
          echo "::group::Ruff Format Check (Python ${{ matrix.python-version }})"
          uv run python -m ruff format --check .
          echo "::endgroup::"
          echo "::group::Ruff Lint Check (Python ${{ matrix.python-version }})"
          uv run python -m ruff check . --output-format=github
          echo "::endgroup::"

      - name: Run type checker (MyPy) - Python ${{ matrix.python-version }}
        run: |
          echo "::group::MyPy Type Check (Python ${{ matrix.python-version }})"
          uv run python -m mypy . \
            --ignore-missing-imports \
            --allow-untyped-defs \
            --allow-incomplete-defs \
            --allow-untyped-calls \
            --no-strict-optional \
            --junit-xml=mypy-results-py${{ matrix.python-version }}.xml
          echo "::endgroup::"
        continue-on-error: true

      - name: Upload MyPy results
        uses: actions/upload-artifact@v4.4.3
        if: always()
        with:
          name: mypy-results-${{ matrix.servers }}-py${{ matrix.python-version }}
          path: ${{ env.WORKING_DIR }}/${{ matrix.servers }}/mypy-results-py${{ matrix.python-version }}.xml

      - name: Debug Pavo environment access
        if: always() && matrix.python-version == env.DEFAULT_PYTHON_VERSION
        run: |
          echo "=== Pavo Environment Debug ==="
          echo "Environment: Pavo"
          echo "Event: ${{ github.event_name }}"
          echo "Actor: ${{ github.actor }}"
          echo "Ref: ${{ github.ref }}"
          echo "Repository: ${{ github.repository }}"
          echo "Python Version: ${{ matrix.python-version }}"
          echo ""
          echo "=== Secret Availability Check ==="
          if [ -n "${{ secrets.GREENLAKE_API_BASE_URL }}" ]; then
            echo "GREENLAKE_API_BASE_URL: ‚úÖ SET"
          else
            echo "GREENLAKE_API_BASE_URL: ‚ùå NOT SET"
          fi
          
          if [ -n "${{ secrets.GREENLAKE_CLIENT_ID }}" ]; then
            echo "GREENLAKE_CLIENT_ID: ‚úÖ SET"
          else
            echo "GREENLAKE_CLIENT_ID: ‚ùå NOT SET"
          fi
          
          if [ -n "${{ secrets.GREENLAKE_CLIENT_SECRET }}" ]; then
            echo "GREENLAKE_CLIENT_SECRET: ‚úÖ SET"
          else
            echo "GREENLAKE_CLIENT_SECRET: ‚ùå NOT SET"
          fi
          
          if [ -n "${{ secrets.GREENLAKE_TOKEN_ISSUER }}" ]; then
            echo "GREENLAKE_TOKEN_ISSUER: ‚úÖ SET"
          else
            echo "GREENLAKE_TOKEN_ISSUER: ‚ùå NOT SET"
          fi
          
          if [ -n "${{ secrets.GREENLAKE_WORKSPACE_ID }}" ]; then
            echo "GREENLAKE_WORKSPACE_ID: ‚úÖ SET"
          else
            echo "GREENLAKE_WORKSPACE_ID: ‚ùå NOT SET"
          fi
          
          echo ""
          echo "=== MCP Test Secrets ==="
          if [ -n "${{ secrets.MCP_TEST_AUDIT_LOGS_ID }}" ]; then
            echo "MCP_TEST_AUDIT_LOGS_ID: ‚úÖ SET"
          else
            echo "MCP_TEST_AUDIT_LOGS_ID: ‚ùå NOT SET"
          fi
          
          if [ -n "${{ secrets.MCP_TEST_DEVICES_ID }}" ]; then
            echo "MCP_TEST_DEVICES_ID: ‚úÖ SET"
          else
            echo "MCP_TEST_DEVICES_ID: ‚ùå NOT SET"
          fi
          
          if [ -n "${{ secrets.MCP_TEST_SAMPLE_SERVICE_PETID }}" ]; then
            echo "MCP_TEST_SAMPLE_SERVICE_PETID: ‚úÖ SET"
          else
            echo "MCP_TEST_SAMPLE_SERVICE_PETID: ‚ùå NOT SET"
          fi
          echo "=============================="

      # ==========================================
      # TESTS (Run on all Python versions)
      # ==========================================

      - name: Run unit tests - Python ${{ matrix.python-version }}
        if: always()
        run: |
          if [[ -d "tests/unit" ]]; then
            echo "::group::Unit Tests for ${{ matrix.servers }} (Python ${{ matrix.python-version }})"
            echo "Running unit tests for ${{ matrix.servers }} on Python ${{ matrix.python-version }}..."
            uv run python -m pytest tests/unit/ -v --tb=short --junitxml=unit-test-results-py${{ matrix.python-version }}.xml
            echo "::endgroup::"
          else
            echo "No unit tests found for ${{ matrix.servers }}"
          fi

      - name: Run integration tests - Python ${{ matrix.python-version }}
        if: always()
        env:
          # Note: These secrets may not be available for external PRs
          # They will only run for authorized users/teams
          GREENLAKE_API_BASE_URL: ${{ secrets.GREENLAKE_API_BASE_URL }}
          GREENLAKE_CLIENT_ID: ${{ secrets.GREENLAKE_CLIENT_ID }}
          GREENLAKE_CLIENT_SECRET: ${{ secrets.GREENLAKE_CLIENT_SECRET }}
          GREENLAKE_TOKEN_ISSUER: ${{ secrets.GREENLAKE_TOKEN_ISSUER }}
          GREENLAKE_WORKSPACE_ID: ${{ secrets.GREENLAKE_WORKSPACE_ID }}
          MCP_TEST_AUDIT_LOGS_ID: ${{ secrets.MCP_TEST_AUDIT_LOGS_ID }}
          MCP_TEST_DEVICES_ID: ${{ secrets.MCP_TEST_DEVICES_ID }}
          MCP_TEST_SAMPLE_SERVICE_PETID: ${{ secrets.MCP_TEST_SAMPLE_SERVICE_PETID }}
          MCP_TEST_SUBSCRIPTIONS_ID: ${{ secrets.MCP_TEST_SUBSCRIPTIONS_ID }}
          MCP_TEST_USERS_ID: ${{ secrets.MCP_TEST_USERS_ID }}
          MCP_TEST_WORKSPACES_WORKSPACEID: ${{ secrets.GREENLAKE_WORKSPACE_ID }}
        run: |
          if [[ -d "tests/integration" ]]; then
            echo "::group::Integration Tests for ${{ matrix.servers }} (Python ${{ matrix.python-version }})"
            echo "Running integration tests for ${{ matrix.servers }} on Python ${{ matrix.python-version }}..."
            uv run python -m pytest tests/integration/ -v --tb=short --junitxml=integration-test-results-py${{ matrix.python-version }}.xml
            echo "::endgroup::"
          else
            echo "No integration tests found for ${{ matrix.servers }}"
          fi

      - name: Run E2E tests - Python ${{ matrix.python-version }}
        if: always()
        env:
          GREENLAKE_API_BASE_URL: ${{ secrets.GREENLAKE_API_BASE_URL }}
          GREENLAKE_CLIENT_ID: ${{ secrets.GREENLAKE_CLIENT_ID }}
          GREENLAKE_CLIENT_SECRET: ${{ secrets.GREENLAKE_CLIENT_SECRET }}
          GREENLAKE_TOKEN_ISSUER: ${{ secrets.GREENLAKE_TOKEN_ISSUER }}
          GREENLAKE_WORKSPACE_ID: ${{ secrets.GREENLAKE_WORKSPACE_ID }}
        run: |
          if [[ -d "tests/e2e" ]]; then
            echo "::group::E2E Tests for ${{ matrix.servers }} (Python ${{ matrix.python-version }})"
            echo "Running E2E tests for ${{ matrix.servers }} on Python ${{ matrix.python-version }}..."
            uv run python -m pytest tests/e2e/ -v --tb=short --junitxml=e2e-test-results-py${{ matrix.python-version }}.xml
            echo "::endgroup::"
          else
            echo "No E2E tests found for ${{ matrix.servers }}"
          fi

      - name: üìä Test Summary for ${{ matrix.servers }} (Python ${{ matrix.python-version }})
        if: always()
        run: |
            echo "## üìä Test Summary for \`${{ matrix.servers }}\` (Python ${{ matrix.python-version }})" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            # Check each test type
            if [[ -f "unit-test-results-py${{ matrix.python-version }}.xml" ]]; then
            echo "- ‚úÖ Unit tests: Completed" >> $GITHUB_STEP_SUMMARY
            else
            echo "- ‚è≠Ô∏è Unit tests: No tests found" >> $GITHUB_STEP_SUMMARY
            fi
            
            if [[ -f "integration-test-results-py${{ matrix.python-version }}.xml" ]]; then
            echo "- ‚úÖ Integration tests: Completed" >> $GITHUB_STEP_SUMMARY
            else
            echo "- ‚è≠Ô∏è Integration tests: No tests found" >> $GITHUB_STEP_SUMMARY
            fi
            
            if [[ -f "e2e-test-results-py${{ matrix.python-version }}.xml" ]]; then
            echo "- ‚úÖ E2E tests: Completed" >> $GITHUB_STEP_SUMMARY
            else
            echo "- ‚è≠Ô∏è E2E tests: No tests found" >> $GITHUB_STEP_SUMMARY
            fi
            
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Status**: CI completed for ${{ matrix.servers }} on Python ${{ matrix.python-version }} ‚úÖ" >> $GITHUB_STEP_SUMMARY

      - name: Upload test results
        uses: actions/upload-artifact@v4.4.3
        if: always()
        with:
          name: test-results-${{ matrix.servers }}-py${{ matrix.python-version }}
          path: |
            ${{ env.WORKING_DIR }}/${{ matrix.servers }}/unit-test-results-py${{ matrix.python-version }}.xml
            ${{ env.WORKING_DIR }}/${{ matrix.servers }}/integration-test-results-py${{ matrix.python-version }}.xml
            ${{ env.WORKING_DIR }}/${{ matrix.servers }}/e2e-test-results-py${{ matrix.python-version }}.xml
          if-no-files-found: ignore

      - name: Build package - Python ${{ matrix.python-version }}
        if: always()
        run: |
          echo "::group::Building package for ${{ matrix.servers }} (Python ${{ matrix.python-version }})"
          uv build

          # Validate package metadata (Python version compatible)
          uv run python -c "
          import sys
          try:
              # Use tomllib for Python 3.11+ or tomli/toml for older versions
              if sys.version_info >= (3, 11):
                  import tomllib
                  with open('pyproject.toml', 'rb') as f:
                      config = tomllib.load(f)
              else:
                  # Fallback for Python 3.10 and older
                  try:
                      import tomli as tomllib
                      with open('pyproject.toml', 'rb') as f:
                          config = tomllib.load(f)
                  except ImportError:
                      import toml
                      with open('pyproject.toml', 'r') as f:
                          config = toml.load(f)
              
              print('‚úÖ Package name:', config['project']['name'])
              print('‚úÖ Version:', config['project']['version'])
              print('‚úÖ Description:', config['project']['description'])
              print('‚úÖ Python version used:', sys.version.split()[0])
          except Exception as e:
              print('‚ùå Error reading package metadata:', e)
              print('Python version:', sys.version.split()[0])
              # Don't fail the build for metadata validation issues
              print('‚ö†Ô∏è Continuing despite metadata validation error')
          "
          echo "::endgroup::"

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4.4.3
        if: always()
        with:
          name: dist-packages-${{ matrix.servers }}-py${{ matrix.python-version }}
          path: ${{ env.WORKING_DIR }}/${{ matrix.servers }}/dist/

      - name: Test package installation - Python ${{ matrix.python-version }}
        if: always()
        run: |
          echo "::group::Testing package installation for ${{ matrix.servers }} (Python ${{ matrix.python-version }})"
          cd /tmp
          uv venv test-env --python ${{ matrix.python-version }}
          source test-env/bin/activate

          # Find the wheel file
          wheel_file=$(find ${{ github.workspace }}/${{ env.WORKING_DIR }}/${{ matrix.servers }}/dist/ -name "*.whl" | head -n 1)
          if [[ -z "$wheel_file" ]]; then
            echo "‚ùå No wheel file found"
            exit 1
          fi

          echo "Installing: $wheel_file"
          uv pip install "$wheel_file"
          python -c "print('‚úÖ Package installed successfully')"
          echo "::endgroup::"

  status-check:
    name: Quality Gate
    runs-on: ubuntu-latest
    needs: [check-authorization, check-changes, lint-markdown, ci-checks]
    if: always()

    steps:
      - name: Check if CI should run
        run: |
          if [[ "${{ needs.check-changes.outputs.should-run }}" != "true" ]]; then
            echo "‚è≠Ô∏è No relevant changes detected - skipping CI"
            exit 0
          fi

      - name: Check authorization status
        run: |
          if [[ "${{ needs.check-authorization.result }}" == "success" ]]; then
            echo "‚úÖ Authorization passed"
          elif [[ "${{ needs.check-authorization.result }}" == "skipped" ]]; then
            echo "‚è≠Ô∏è Authorization skipped"
          else
            echo "‚ùå Authorization failed"
            exit 1
          fi

      - name: Check markdown linting
        run: |
          if [[ "${{ needs.lint-markdown.result }}" == "success" ]]; then
            echo "‚úÖ Markdown linting passed"
          elif [[ "${{ needs.lint-markdown.result }}" == "skipped" ]]; then
            echo "‚è≠Ô∏è Markdown linting skipped"
          else
            echo "‚ùå Markdown linting failed"
            exit 1
          fi

      - name: CI checks status check
        run: |
          if [[ "${{ needs.ci-checks.result }}" == "success" ]]; then
            echo "‚úÖ All CI checks passed!"
          elif [[ "${{ needs.ci-checks.result }}" == "skipped" ]]; then
            echo "‚è≠Ô∏è CI checks were skipped"
          else
            echo "‚ùå CI checks failed with status: ${{ needs.ci-checks.result }}"
            exit 1
          fi

      - name: Final summary
        run: |
          echo "========================================="
          echo "Quality Gate Summary"
          echo "========================================="
          echo "Authorization: ${{ needs.check-authorization.result }}"
          echo "Change Detection: ${{ needs.check-changes.result }}"
          echo "Markdown Lint: ${{ needs.lint-markdown.result }}"
          echo "CI Checks: ${{ needs.ci-checks.result }}"
          echo "========================================="
          
          if [[ "${{ needs.check-changes.outputs.should-run }}" == "true" ]]; then
            echo "Tested servers: ${{ needs.check-changes.outputs.servers }}"
            echo "‚úÖ All quality checks passed!"
          else
            echo "‚è≠Ô∏è No relevant changes - CI skipped"
          fi